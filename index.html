<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Esc√°ner Pro HD</title>
  <style>
    :root { --primary: #007aff; --bg: #f2f2f7; --card: #ffffff; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 16px; background: var(--bg); color: #1c1c1e;
    }
    
    /* UI Elements */
    .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    h1 { font-size: 24px; margin: 0 0 20px; text-align: center; color: var(--primary); letter-spacing: -0.5px; }
    
    label { display: block; font-size: 13px; font-weight: 600; color: #8e8e93; margin: 12px 0 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    input {
      width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #d1d1d6;
      font-size: 17px; background: #fff; -webkit-appearance: none;
    }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }

    /* Botones */
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    button {
      flex: 1; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: transform 0.1s;
    }
    button:active { transform: scale(0.96); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: #ff3b30; color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    
    /* C√°mara y Esc√°ner */
    #reader-wrapper {
      position: relative; border-radius: 16px; overflow: hidden; background: #000;
      display: none; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    #reader { width: 100%; height: 100%; object-fit: cover; }
    
    /* Gu√≠a Visual (Cuadro Rojo) */
    .scan-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      background: 
        linear-gradient(to right, rgba(0,0,0,0.6) 10%, transparent 10%, transparent 90%, rgba(0,0,0,0.6) 90%),
        linear-gradient(to bottom, rgba(0,0,0,0.6) 10%, transparent 10%, transparent 90%, rgba(0,0,0,0.6) 90%);
      z-index: 10;
    }
    .scan-guide {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 80%; height: 150px; border: 2px solid rgba(255, 0, 0, 0.7);
      border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    .scan-laser {
      width: 100%; height: 2px; background: red; position: absolute; top: 50%;
      box-shadow: 0 0 10px red; animation: scan-anim 2s infinite ease-in-out;
    }
    @keyframes scan-anim { 0%, 100% { top: 10%; opacity: 0; } 50% { top: 90%; opacity: 1; } }

    /* Estado */
    #feedback {
      text-align: center; font-weight: 600; padding: 10px; border-radius: 8px;
      margin-top: 10px; display: none;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

  <div class="card">
    <h1>üì¶ Inventario Pro HD</h1>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <div style="flex: 1; text-align: center; background: #e5f1ff; padding: 10px; border-radius: 10px;">
        <div style="font-size: 24px; font-weight: bold; color: #007aff;" id="sessionCount">0</div>
        <div style="font-size: 10px; text-transform: uppercase;">Escaneos</div>
      </div>
      <div style="flex: 1; text-align: center; background: #e5f1ff; padding: 10px; border-radius: 10px;">
        <div style="font-size: 24px; font-weight: bold; color: #007aff;" id="lastStock">-</div>
        <div style="font-size: 10px; text-transform: uppercase;">Stock</div>
      </div>
    </div>

    <label>Ubicaci√≥n</label>
    <input type="text" id="device" placeholder="Ej. Estante A1" />
  </div>

  <div class="card">
    <button id="btnStart" class="btn-primary">üì∑ Iniciar Esc√°ner HD</button>
    
    <div id="reader-wrapper">
      <div id="reader"></div>
      <div class="scan-guide"><div class="scan-laser"></div></div>
      <button id="btnStop" class="btn-danger" style="position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 20;">Detener C√°mara</button>
    </div>

    <div id="feedback"></div>

    <div id="dataForm">
      <label>C√≥digo Detectado</label>
      <input type="text" id="barcode" placeholder="Escanea o escribe..." style="font-family: monospace; font-weight: bold; color: #007aff;" />
      
      <div style="display: flex; gap: 10px;">
        <div style="flex: 1;">
          <label>Cantidad</label>
          <input type="number" id="qty" value="1" min="1" />
        </div>
        <div style="flex: 2;">
          <label>Marca</label>
          <input type="text" id="brand" placeholder="Marca" />
        </div>
      </div>

      <label>Descripci√≥n</label>
      <input type="text" id="desc" placeholder="Nombre del producto" />

      <label>Modelo / Nota</label>
      <input type="text" id="model" placeholder="Detalles extra..." />

      <button id="btnSend" class="btn-primary" style="margin-top: 20px;" disabled>‚úÖ Enviar Registro</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // ==========================================
    // CONFIGURACI√ìN (Actualiza tu URL aqu√≠)
    // ==========================================
    const APP_CONFIG = {
      url: "https://script.google.com/macros/s/AKfycbzuewP1k1PXI44KLdlkAm25zS4QqHgkfzfRbbQV5G6xl6UZIOSfktjaPIEv0yx0otZc/exec",
      token: "refaccionaria_2025_token_secreto"
    };

    let html5QrCode;
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnSend = document.getElementById('btnSend');
    const feedback = document.getElementById('feedback');
    
    // Inputs
    const inputs = {
      barcode: document.getElementById('barcode'),
      qty: document.getElementById('qty'),
      brand: document.getElementById('brand'),
      desc: document.getElementById('desc'),
      model: document.getElementById('model'),
      device: document.getElementById('device')
    };

    // 1. INICIAR C√ÅMARA (VERSI√ìN FLEXIBLE)
    btnStart.addEventListener('click', async () => {
      document.getElementById('reader-wrapper').style.display = 'block';
      btnStart.style.display = 'none';
      showMsg("Iniciando c√°mara...", "normal");

      html5QrCode = new Html5Qrcode("reader");

      const config = {
        fps: 20, // Bajamos un poco para asegurar compatibilidad
        qrbox: { width: 250, height: 150 },
        aspectRatio: 1.0
      };

      try {
        // INTENTO 1: Configuraci√≥n Ideal (C√°mara trasera, HD)
        await html5QrCode.start(
          { 
            facingMode: "environment",
            width: { ideal: 1280 }, // "Idealmente" HD, pero no obligatorio
            height: { ideal: 720 } 
          },
          config,
          onScanSuccess,
          () => {}
        );
        showMsg("C√°mara activa.", "normal");

      } catch (err) {
        console.warn("Fallo intento HD, probando modo b√°sico...", err);
        
        try {
          // INTENTO 2: Configuraci√≥n B√°sica (Cualquier c√°mara trasera)
          await html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess, 
            () => {}
          );
           showMsg("C√°mara activa (Modo B√°sico).", "normal");
           
        } catch (err2) {
          // Si falla todo, mostramos el error REAL
          console.error(err2);
          showMsg("Error cr√≠tico: " + err2.name, "error");
          
          // Ayuda visual para el usuario seg√∫n el error
          if(err2.name == "NotAllowedError") alert("‚ùå PERMISO DENEGADO: Tienes que darle 'Permitir' al navegador para usar la c√°mara.");
          if(err2.name == "NotFoundError") alert("‚ùå NO HAY C√ÅMARA: No se detecta ninguna c√°mara en este dispositivo.");
          
          stopCamera();
        }
      }
    });

    // 2. AL DETECTAR C√ìDIGO
    function onScanSuccess(decodedText, decodedResult) {
      // Evitar lecturas duplicadas inmediatas
      if (inputs.barcode.value === decodedText) return;

      inputs.barcode.value = decodedText;
      
      // Feedback auditivo y vibraci√≥n
      if (navigator.vibrate) navigator.vibrate(200);
      let audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
      audio.play().catch(e => console.log("Audio bloqueado"));

      showMsg("¬°C√≥digo detectado!", "success");
      btnSend.disabled = false;
      
      // Opcional: Detener c√°mara al leer para ahorrar bater√≠a
      stopCamera(); 
    }

    // 3. DETENER C√ÅMARA
    btnStop.addEventListener('click', stopCamera);
    
    async function stopCamera() {
      if (html5QrCode && html5QrCode.isScanning) {
        await html5QrCode.stop();
      }
      document.getElementById('reader-wrapper').style.display = 'none';
      btnStart.style.display = 'block';
    }

    // 4. ENVIAR DATOS
    btnSend.addEventListener('click', async () => {
      if (!inputs.barcode.value) return alert("Falta el c√≥digo");

      const originalText = btnSend.textContent;
      btnSend.textContent = "Enviando...";
      btnSend.disabled = true;

      const payload = {
        token: APP_CONFIG.token,
        barcode: inputs.barcode.value,
        qty: inputs.qty.value,
        brand: inputs.brand.value,
        desc: inputs.desc.value,
        model: inputs.model.value,
        device: inputs.device.value || "Sin Ubicaci√≥n"
      };

      try {
        await fetch(APP_CONFIG.url, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(payload)
        });

        // √âxito simulado (por no-cors)
        showMsg("‚úÖ Guardado en Inventario", "success");
        
        // Limpiar para el siguiente
        inputs.barcode.value = "";
        inputs.qty.value = "1";
        inputs.desc.value = ""; // Opcional: limpiar descripci√≥n
        inputs.brand.value = "";
        inputs.model.value = "";
        
        // Actualizar contador visual
        let count = document.getElementById('sessionCount');
        count.textContent = parseInt(count.textContent) + 1;

      } catch (err) {
        showMsg("Error de conexi√≥n", "error");
      } finally {
        btnSend.textContent = originalText;
        // Esperamos un poco antes de dejar enviar otro para evitar doble click
        setTimeout(() => { if(inputs.barcode.value) btnSend.disabled = false; }, 1000);
      }
    });

    // Auxiliar mensajes
    function showMsg(text, type) {
      feedback.style.display = 'block';
      feedback.textContent = text;
      feedback.className = type;
      if (type === 'success') {
        setTimeout(() => feedback.style.display = 'none', 3000);
      }
    }
  </script>
</body>
</html>


